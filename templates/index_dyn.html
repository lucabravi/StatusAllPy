<!DOCTYPE html>
<html>
<head>
    <title>Ping Status</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
            crossorigin="anonymous"></script>
    <script>
        // Funzione per aggiornare i dati di ping tramite AJAX
        function updatePingStatus() {
            axios.get('/api/ping_status', {timeout: 2000})
                .then(function (response) {
                    var data = response.data;
                    var devices = data['devices'];
                    var groups = data['groups'];
                    updateSummaryCount(groups);
                    var groupsContainer = document.getElementById('groups-container');
                    groupsContainer.innerHTML = '';
                    // Aggiungi le card per ogni gruppo
                    for (var i = 0; i < groups.length; i++) {
                        var group = groups[i];
                        var groupCard = createGroupCard(group, devices[group.name]);
                        groupsContainer.appendChild(groupCard);
                    }
                })
                .catch(function (error) {
                    console.error(error);
                });
        }

        function createGroupCard(group, devices) {
            var card = document.createElement('div');
            card.id = 'group_' + group.name;
            card.className = 'card col-3';

            var cardHeader = document.createElement('div');
            cardHeader.className = 'card-header';

            var cardTitle = document.createElement('h3');
            cardTitle.textContent = group.name;
            cardTitle.appendChild(document.createElement('br'));

            var groupCount = document.createElement('small');
            groupCount.className = 'group-count';
            groupCount.innerHTML = `<span class="text-success"> ${group.online} ON </span> | `
                + `<span class="text-danger"> ${group.count - group.online} OFF </span>`;
            cardTitle.appendChild(groupCount);

            cardHeader.appendChild(cardTitle);
            card.appendChild(cardHeader);

            var cardBody = document.createElement('div');
            cardBody.className = 'card-body';

            for (var i = 0; i < devices.length; i++) {
                var device = devices[i];
                var deviceRow = createDeviceRow(device);
                cardBody.appendChild(deviceRow);
            }

            card.appendChild(cardBody);

            return card;
        }

        function createDeviceRow(device) {
            var deviceRow = document.createElement('div');
            deviceRow.className = 'row align-items-center border-bottom border-top';

            var deviceName = document.createElement('div');
            deviceName.className = 'col-8';
            deviceName.textContent = device.name;

            var deviceStatus = document.createElement('div');
            deviceStatus.className = 'col-4 border-end text-end';

            var statusButton = document.createElement('button');
            statusButton.className = 'btn btn-sm py-0';
            statusButton.classList.add(device.status ? 'btn-success' : 'btn-danger');
            statusButton.textContent = device.status ? 'ON' : 'OFF';

            deviceStatus.appendChild(statusButton);
            deviceRow.appendChild(deviceName);
            deviceRow.appendChild(deviceStatus);

            return deviceRow;
        }

        function updateSummaryCount(groups) {
            var onlineCount = 0;
            var offlineCount = 0;

            // Calcola il conteggio totale dei dispositivi online/offline
            for (var i = 0; i < groups.length; i++) {
                var group = groups[i];
                onlineCount += group.online;
                offlineCount += group.count - group.online;
            }

            var summaryCount = document.getElementById('summary-count');
            if (summaryCount) {
                summaryCount.innerHTML = `<span class="text-success"> ${onlineCount} ON </span> | `
                    + `<span class="text-danger"> ${offlineCount} OFF </span>`;
            }
        }

        // Aggiorna i dati di ping ogni 5 secondi
        setInterval(updatePingStatus, 5000);

        // Inizializza i dati di ping all'avvio
        document.addEventListener('DOMContentLoaded', function () {
            updatePingStatus();
        });
    </script>
</head>
<body>
<div class="container">
    <h1 class="my-3 text-center">Ping Status | <small id="summary-count"></small></h1>
    <!-- Container per le cards dei gruppi -->
    <div id="groups-container" class="row"></div>
</div>
</body>
</html>
